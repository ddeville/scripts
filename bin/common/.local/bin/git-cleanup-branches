#!/bin/bash

# Cleanup local branches that used to have an upstream that was deleted

git fetch --prune &>/dev/null

# Use `git for-each-ref` to safely handle branch names with spaces and avoid
# parsing the output of `git branch`.
git for-each-ref --format='%(refname:short)\t%(upstream:short)' refs/heads |
  while IFS=$'\t' read -r branch upstream; do
    if [ -n "$upstream" ] && ! git show-ref --quiet "refs/remotes/$upstream"; then
      echo "Deleting branch '$branch'"
      git branch -D "$branch"
    fi
  done
