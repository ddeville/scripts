#!/bin/bash

set -eu -o pipefail

force_global=0
if [ "${1:-}" = "--global" ]; then
  force_global=1
  shift
fi

if [ -n "${VIRTUAL_ENV:-}" ] && [ "$force_global" -eq 0 ]; then
  exec python "$@"
fi

toolchain_dir="$XDG_TOOLCHAINS_HOME/python/metadata"
version_file="$toolchain_dir/version"
requirements_file="$toolchain_dir/requirements.txt"

mkdir -p "$toolchain_dir"

cmd=(uv run --no-project)

if [ -f "$version_file" ]; then
  version="$(tr -d '[:space:]' <"$version_file")"
  if [ -n "$version" ]; then
    cmd+=(--python "$version")
  fi
fi

if [ -s "$requirements_file" ]; then
  cmd+=(--with-requirements "$requirements_file")
fi

cmd+=(python "$@")
exec "${cmd[@]}"
