#!/usr/bin/env bash

set -eux

# First update base16
base16_path="$XDG_DATA_HOME/base16"

repos=(
  "https://github.com/tinted-theming/base16-shell.git"
  "https://github.com/tinted-theming/base16-tmux.git"
  "https://github.com/tinted-theming/base16-fzf.git"
  "https://github.com/aarowill/base16-alacritty.git"
)

for repo in "${repos[@]}"; do
  folder_name=$(echo "$repo" | cut -d/ -f5 | cut -d. -f1)
  path="$base16_path/$folder_name"
  # If the repo was never cloned, do so, otherwise just update it
  if [ -d "$path" ]; then
    pushd "$path" || exit 1
    git pull --rebase
    popd || exit 1
  else
    git clone "$repo" "$path"
  fi
done

# Then neovim plugins
packer_path="$XDG_DATA_HOME/site/pack/packer/start/packer.nvim"

if [ ! -d "$packer_path" ]; then
  mkdir -p "$(dirname "$packer_path")"
  git clone https://github.com/wbthomason/packer.nvim "$packer_path"
fi

nvim --headless +PackerUpdate +PackerCompile +qa
nvim --headless -c "autocmd User PackerComplete quitall" -c "PackerSync"

# And finally tmux plugins
tpm_path="$TMUX_PLUGIN_MANAGER_PATH/tpm"

if [ ! -d "$tpm_path" ]; then
  mkdir -p "$(dirname "$tpm_path")"
  git clone https://github.com/tmux-plugins/tpm "$tpm_path"
fi

# If tmux is running, make sure that we update the env variable in case it has a stale one
if ! tmux info &>/dev/null; then
  tmux set-environment -g "TMUX_PLUGIN_MANAGER_PATH" "$XDG_DATA_HOME/tmux/plugins/"
fi

"$TMUX_PLUGIN_MANAGER_PATH"/tpm/bin/install_plugins
"$TMUX_PLUGIN_MANAGER_PATH"/tpm/bin/update_plugins all
