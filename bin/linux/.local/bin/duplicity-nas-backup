#!/bin/bash
set -e

if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root"
   exit 1
fi

DEST="rsync://duplicity@nas.home.kattungar.net//volume1/Duplicity/$(hostname)"
KEY_FILE="/etc/duplicity/credentials/nas_key"

# Back things up!
#
# - Only backup the home directory
# - No need to encrypt since the Synology shared folder is encrypted anyway
# - Full backup every 14 days, otherwise incremental
# - Keep 12 full backups, around 6M worth of backup
#
# Note that earlier `include/exclude` "override" the ones that come after in the
# command line arguments so we put the catch-all ones last.
duplicity --no-encryption \
          --ssh-options="-oIdentityFile='$KEY_FILE'" \
          --full-if-older-than 14D \
          --exclude ignorecase:/**/cache/** \
          --exclude ignorecase:/**/.cache/** \
          --exclude /home/damien/data \
          /home \
          "$DEST"

# Clean things up a little
duplicity remove-all-but-n-full 12 \
          --ssh-options="-oIdentityFile='$KEY_FILE'" \
          --force \
          "$DEST"

# And show a helpful status
duplicity collection-status \
          --ssh-options="-oIdentityFile='$KEY_FILE'" \
          "$DEST"
