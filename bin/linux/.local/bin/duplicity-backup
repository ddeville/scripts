#!/bin/bash

DEST="file:///home/damien/data/Backup"
FULL_LIMIT=64

CREDS="/etc/duplicity/credentials/passphrase_damien"

if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root"
   exit 1
fi

# If the env vars aren't set (likely because the script was run directly rather
# than from systemd), let's read them from the config file and export them.
if [ -z "$PASSPHRASE" ]
then
   if [ ! -f "$CREDS" ]
   then
      echo "Credentials cannot be read at $CREDS"
      exit 1
   fi

   while read -r line
   do
      if [[ "$line" == \#* ]] || [[ "$line" != *=* ]]
      then
         continue
      fi
      export $line
   done <"$CREDS"
fi

# Back things up!
#
# Note that earlier `include/exclude` "override" the ones that come after in the
# command line arguments so we put the catch-all ones last.
duplicity --exclude /home/damien/.cache \
          --exclude /home/damien/data \
          --include /home \
          --exclude '**' \
          / "$DEST"

# Clean things up a little
duplicity remove-all-but-n-full $FULL_LIMIT --force "$DEST"
duplicity cleanup --force "$DEST"

# And show a helpful status
duplicity collection-status "$DEST"
