#!/bin/bash
set -e

if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root"
   exit 1
fi

case $1 in
   local)
      DEST="file:///home/damien/data/Backup"
      CREDS=()
      ;;
   nas)
      DEST="rsync://duplicity@nas.home.kattungar.net//volume1/Duplicity/$(hostname)"
      CREDS=(
         "--ssh-options"
         "-oIdentityFile='/etc/duplicity/credentials/nas_key'"
      )
      ;;
   *)
      echo "Unknown command (needs to be 'local' or 'nas')"
      exit 1
esac

# The list of directories to exclude when backing up the root directory.
#
# Note that earlier `include/exclude` "override" the ones that come after in the
# command line arguments so we put the catch-all ones last.
EXCLUDES=(
   "--exclude ignorecase:/**/cache/**"
   "--exclude ignorecase:/**/.cache/**"
   "--exclude /home/damien/data"
   "--exclude /dev"
   "--exclude /mnt"
   "--exclude /proc"
   "--exclude /run"
   "--exclude /sys"
   "--exclude /tmp"
   "--exclude /var/lock"
   "--exclude /var/run"
   "--exclude /var/tmp"
)

# Back up the entire system!
# Full backup every 14 days, otherwise incremental, and no encryption necessary.
duplicity --no-encryption --full-if-older-than=14D ${CREDS[@]} ${EXCLUDES[@]} / "$DEST"

# Keep 12 full backups, around 6M worth of data.
duplicity remove-all-but-n-full 12 --force ${CREDS[@]} "$DEST"

# And show a helpful status.
duplicity collection-status ${CREDS[@]} "$DEST"
