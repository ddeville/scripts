#!/bin/bash

set -eu -o pipefail

LINUXBREW_PATH=/home/linuxbrew/.linuxbrew
FILTERED_PATH=/home/linuxbrew/filtered

if [ ! -d $LINUXBREW_PATH ]; then
  echo "Brew isn't installed on this system!"
  exit 1
fi

rm -rf $FILTERED_PATH
mkdir -p $FILTERED_PATH/bin $FILTERED_PATH/sbin

PACKAGES=$(brew leaves)

for pkg in $PACKAGES; do
  prefix=$(brew --prefix "$pkg")

  if [ -d "$prefix/bin" ]; then
    find "$prefix/bin" -type f -executable -exec ln -sf {} "$FILTERED_PATH/bin/" \;
  fi
  if [ -d "$prefix/sbin" ]; then
    find "$prefix/sbin" -type f -executable -exec ln -sf {} "$FILTERED_PATH/sbin/" \;
  fi
done
